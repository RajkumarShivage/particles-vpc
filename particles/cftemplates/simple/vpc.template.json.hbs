{{#layout}}
  {{{parameter 'vpc_cidr' logicalId="VpcCidr"}}}

  {{{set 'simple/create_vpc_security_group'}}}
  {{{set 'simple/open_vpc_communication'}}}
  {{{set 'simple/create_internet_gateway'}}}

  {{{parameter 'name_tag' logicalId="NameTag"}}}

  {{#resource logicalId="Vpc"}}
    "Type": "AWS::EC2::VPC",
    "Properties": {
      "CidrBlock": {
        "Ref": "VpcCidr"
      },
      "InstanceTenancy": "default",
      "EnableDnsSupport": "true",
      "EnableDnsHostnames": "true",
      "Tags": [
        {
          "Key": "Name",
          "Value": {
            "Ref": "NameTag"
          }
        }
      ]
    }
  {{/resource}}

  {{#resource logicalId="InternetGateway"}}
    "Type": "AWS::EC2::InternetGateway",
    "Condition": "CreateInternetGatewayCond",
    "Properties": {
      "Tags": [
        {
          "Key": "Name",
          "Value": {
            "Ref": "NameTag"
          }
        }
      ]
    }
  {{/resource}}

  {{#resource logicalId="NetworkAcl"}}
    "Type": "AWS::EC2::NetworkAcl",
    "Properties": {
      "VpcId": {
        "Ref": "Vpc"
      }
    }
  {{/resource}}

  {{#resource logicalId="RouteTable"}}
    "Type": "AWS::EC2::RouteTable",
    "Properties": {
      "VpcId": {
        "Ref": "Vpc"
      },
      "Tags": [
        {
          "Key": "Name",
          "Value": {
            "Ref": "NameTag"
          }
        }
      ]
    }
  {{/resource}}

  {{#resource logicalId="VpcSecurityGroup"}}
    "Type": "AWS::EC2::SecurityGroup",
    "Condition": "CreateVpcSecurityGroupCond",
    "Properties": {
      "GroupDescription": "VPC Default Security Group",
      "VpcId": {
        "Ref": "Vpc"
      },
      "SecurityGroupEgress": [
        {
          "IpProtocol": "-1",
          "CidrIp": "0.0.0.0/0"
        }
      ],
      "Tags": [
        {
          "Key": "Name",
          "Value": {
            "Ref": "NameTag"
          }
        }
      ]
    }
  {{/resource}}

  {{#resource logicalId="SecurityGroupIngress"}}
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Condition": "OpenVpcCommunicationCond",
    "Properties": {
      "GroupId": {
        "Fn::GetAtt": ["VpcSecurityGroup","GroupId"]
      },
      "IpProtocol": "-1",
      "SourceSecurityGroupId": {
        "Fn::GetAtt": ["VpcSecurityGroup","GroupId"]
      }
    }
  {{/resource}}

  {{#resource logicalId="Acl1"}}
    "Type": "AWS::EC2::NetworkAclEntry",
    "Properties": {
      "CidrBlock": "0.0.0.0/0",
      "Egress": true,
      "Protocol": "-1",
      "RuleAction": "allow",
      "RuleNumber": "100",
      "NetworkAclId": {
        "Ref": "NetworkAcl"
      }
    }
  {{/resource}}

  {{#resource logicalId="Acl2"}}
    "Type": "AWS::EC2::NetworkAclEntry",
    "Properties": {
      "CidrBlock": "0.0.0.0/0",
      "Protocol": "-1",
      "RuleAction": "allow",
      "RuleNumber": "100",
      "NetworkAclId": {
        "Ref": "NetworkAcl"
      }
    }
  {{/resource}}

  {{#resource logicalId="GatewayAttachment"}}
    "Type": "AWS::EC2::VPCGatewayAttachment",
    "Condition": "CreateInternetGatewayCond",
    "Properties": {
      "VpcId": {
        "Ref": "Vpc"
      },
      "InternetGatewayId": {
        "Ref": "InternetGateway"
      }
    }
  {{/resource}}

  {{#resource logicalId="DefaultRoute"}}
    "Type": "AWS::EC2::Route",
    "Condition": "CreateInternetGatewayCond",
    "Properties": {
      "DestinationCidrBlock": "0.0.0.0/0",
      "RouteTableId": {
        "Ref": "RouteTable"
      },
      "GatewayId": {
        "Ref": "InternetGateway"
      }
    },
    "DependsOn": "InternetGateway"
  {{/resource}}

  {{#output logicalId="VpcId"}}
    "Value": {
      "Ref": "Vpc"
    }
  {{/output}}

  {{#output logicalId="RouteTableId"}}
    "Value": {
      "Ref": "RouteTable"
    }
  {{/output}}

  {{#output logicalId="SecurityGroupId"}}
    "Value": {
      "Ref": "VpcSecurityGroup"
    },
    "Condition": "CreateVpcSecurityGroupCond"
  {{/output}}

{{/layout}}
