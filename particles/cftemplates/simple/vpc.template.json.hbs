{{#layout}}
  {{{parameter 'vpc_cidr' logicalId="VpcCidr"}}}

  {{{
    parameter 'module:particles-common-core' 'true_false'
    logicalId="CreateVpcSecurityGroup"
    default="false"
    description="[true|false] Create a security group assigned to the new VPC"
  }}}

  {{{
    parameter 'module:particles-common-core' 'true_false'
    logicalId="OpenVpcCommunication"
    default="false"
    description="[true|false] Open all communication within the VPC"
  }}}

  {{{
    parameter 'module:particles-common-core' 'true_false'
    logicalId="CreateInternetGateway"
    default="false"
    description="[true|false] Create an Internet Gateway for the VPC"
  }}}

  {{{parameter 'name_tag' logicalId="NameTag"}}}

  {{{condition 'module:particles-common-core' 'is_true' logicalId="CondCreateVpcSecurityGroup" parameterName="CreateVpcSecurityGroup"}}},
  {{{condition 'module:particles-common-core' 'is_true' logicalId="CondOpenVpcCommunication" parameterName="OpenVpcCommunication"}}},
  {{{condition 'module:particles-common-core' 'is_true' logicalId="CondCreateInternetGateway" parameterName="CreateInternetGateway"}}}

  {{#resource logicalId="Vpc"}}
    "Type": "AWS::EC2::VPC",
    "Properties": {
      "CidrBlock": {
        "Ref": "VpcCidr"
      },
      "InstanceTenancy": "default",
      "EnableDnsSupport": "true",
      "EnableDnsHostnames": "true",
      "Tags": [
        {
          "Key": "Name",
          "Value": {
            "Ref": "NameTag"
          }
        }
      ]
    }
  {{/resource}}

  {{#resource logicalId="InternetGateway"}}
    "Type": "AWS::EC2::InternetGateway",
    "Condition": "CondCreateInternetGateway",
    "Properties": {
      "Tags": [
        {
          "Key": "Name",
          "Value": {
            "Ref": "NameTag"
          }
        }
      ]
    }
  {{/resource}}

  {{#resource logicalId="NetworkAcl"}}
    "Type": "AWS::EC2::NetworkAcl",
    "Properties": {
      "VpcId": {
        "Ref": "Vpc"
      }
    }
  {{/resource}}

  {{#resource logicalId="RouteTable"}}
    "Type": "AWS::EC2::RouteTable",
    "Properties": {
      "VpcId": {
        "Ref": "Vpc"
      },
      "Tags": [
        {
          "Key": "Name",
          "Value": {
            "Ref": "NameTag"
          }
        }
      ]
    }
  {{/resource}}

  {{#resource logicalId="VpcSecurityGroup"}}
    "Type": "AWS::EC2::SecurityGroup",
    "Condition": "CondCreateVpcSecurityGroup",
    "Properties": {
      "GroupDescription": "VPC Default Security Group",
      "VpcId": {
        "Ref": "Vpc"
      },
      "SecurityGroupEgress": [
        {
          "IpProtocol": "-1",
          "CidrIp": "0.0.0.0/0"
        }
      ],
      "Tags": [
        {
          "Key": "Name",
          "Value": {
            "Ref": "NameTag"
          }
        }
      ]
    }
  {{/resource}}

  {{#resource logicalId="SecurityGroupIngress"}}
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Condition": "CondOpenVpcCommunication",
    "Properties": {
      "GroupId": {
        "Fn::GetAtt": ["VpcSecurityGroup","GroupId"]
      },
      "IpProtocol": "-1",
      "SourceSecurityGroupId": {
        "Fn::GetAtt": ["VpcSecurityGroup","GroupId"]
      }
    }
  {{/resource}}

  {{#resource logicalId="Acl1"}}
    "Type": "AWS::EC2::NetworkAclEntry",
    "Properties": {
      "CidrBlock": "0.0.0.0/0",
      "Egress": true,
      "Protocol": "-1",
      "RuleAction": "allow",
      "RuleNumber": "100",
      "NetworkAclId": {
        "Ref": "NetworkAcl"
      }
    }
  {{/resource}}

  {{#resource logicalId="Acl2"}}
    "Type": "AWS::EC2::NetworkAclEntry",
    "Properties": {
      "CidrBlock": "0.0.0.0/0",
      "Protocol": "-1",
      "RuleAction": "allow",
      "RuleNumber": "100",
      "NetworkAclId": {
        "Ref": "NetworkAcl"
      }
    }
  {{/resource}}

  {{#resource logicalId="GatewayAttachment"}}
    "Type": "AWS::EC2::VPCGatewayAttachment",
    "Condition": "CondCreateInternetGateway",
    "Properties": {
      "VpcId": {
        "Ref": "Vpc"
      },
      "InternetGatewayId": {
        "Ref": "InternetGateway"
      }
    }
  {{/resource}}

  {{#resource logicalId="DefaultRoute"}}
    "Type": "AWS::EC2::Route",
    "Condition": "CondCreateInternetGateway",
    "Properties": {
      "DestinationCidrBlock": "0.0.0.0/0",
      "RouteTableId": {
        "Ref": "RouteTable"
      },
      "GatewayId": {
        "Ref": "InternetGateway"
      }
    },
    "DependsOn": "InternetGateway"
  {{/resource}}

  {{#output logicalId="VpcId"}}
    "Value": {
      "Ref": "Vpc"
    }
  {{/output}}

  {{#output logicalId="RouteTableId"}}
    "Value": {
      "Ref": "RouteTable"
    }
  {{/output}}

  {{#output logicalId="SecurityGroupId"}}
    "Value": {
      "Ref": "VpcSecurityGroup"
    },
    "Condition": "CondCreateVpcSecurityGroup"
  {{/output}}

{{/layout}}
